services:
  nginx:
    image: nginx:latest
    container_name: invasiflora_nginx
    ports:
      - "8082:80"
      - "443:443"  
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - .:/app
      - ./public:/var/www/html # æˆ–æ ¹æ“šä½  vhost è¨­å®šèª¿æ•´
      - ../invasi_files:/app/public/invasi_files:ro # ğŸ‘ˆ åŠ é€™è¡Œï¼
      - ./certs:/etc/nginx/certs:ro   # <--- æ–°å¢é€™è¡Œï¼ŒæŠŠæ†‘è­‰æ›é€²å»
    depends_on:
      - app

  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: invasiflora_app
    working_dir: /app
    volumes:
      - .:/app
      - /app/node_modules # <-- é‡é»ï¼šé€™è¡Œè®“ node_modules ç”¨ container å…§è‡ªå·±çš„ï¼Œä¸åŒæ­¥ Windows
      - ../invasi_files:/app/public/invasi_files
    depends_on:
      - db
    ports:
      - "5173:5173" # âœ… é€™é‚Šé–‹æ”¾ Vite çš„é–‹ç™¼ä¼ºæœå™¨ port
    expose:
      - "9000"
    environment:
      - MODE=development # âœ… å¯åˆ‡æ›æˆ production é€²è¡Œéƒ¨ç½²
    # command: ["npm", "run", "dev"]

  db:
    image: mysql:8.0
    container_name: invasiflora_db
    restart: always
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: laravel
      MYSQL_USER: laravel
      MYSQL_PASSWORD: laravel
    volumes:
      - db_data:/var/lib/mysql
      # - ./initdb:/docker-entrypoint-initdb.d

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:5.2.1
    container_name: invasiflora_pma
    ports:
      - "8083:8080"
    depends_on:
      - db
    environment:
      - PMA_HOST=db
      - PHP_UPLOAD_MAX_FILESIZE=64M
      - COOKIE_SECURE=false

volumes:
  db_data:
networks:
  default:
    driver: bridge
